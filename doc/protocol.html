<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Casycom Protocol</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="index" type="text/xhtml+xml" href="index.html" />
    <meta http-equiv="Content-Type" content="text/xhtml+xml; charset=ISO-8859-1" />
    <meta name="Description" content="Technical specification of the casycom wire protocol" />
    <meta name="Keywords" content="Casycom, protocol, specification" />
    <meta name="author" content="Mike Sharov" />
    <meta name="date" content="2015-04-11" />
</head>
<body>
<div id="pagectr"><div id="header">

<h1>Casycom Protocol</h1>

</div><div id="content">
<p>
casycom communicates over a socket connection, UNIX or TCP, using a stream
of messages containing the marshalled arguments of object method calls.
Each message consists of header and body. The header, the body, and the
end of the message must be 8-byte aligned. All integers are written in
little-endian byte order. The header is:
</p><pre>
struct {
    uint32_t    sz;
    uint16_t    iid;
    uint8_t     fdoffset;
    uint8_t     hsz;
    char	objname[];
    char	method[];
    char	signature[];
}
</pre><p>
<tt>sz</tt> is the size of the message body padded to 8 byte alignment.
<tt>hsz</tt> is the size of the header padded to 8 byte alignment.
<tt>fdoffset</tt> is the offset of the passed file descriptor in the
body; if no file descriptor is passed, this should be <tt>0xff</tt>.
</p><p>
<tt>iid</tt> is the instance id of the destination object, generated by
the caller to be unique for the connection. To distinguish objects created
by each side of the socket, the <tt>iid</tt> for the remote object is the
same as the object id inside the client process, defined as the side that
calls <tt>connect</tt> on the socket. Objects created on the client side
by the server side are set to server object id + 32000. The side type
is set by passing EXTERN_CLIENT or EXTERN_SERVER to the PExtern_Open call.
</p><p>
<tt>objname</tt>,
<tt>method</tt>, and
<tt>signature</tt> encode the message destination.
All three are zero-terminated strings, concatenated together and directly
following <tt>hsz</tt>. <tt>objname</tt> names the addressed interface,
such as "Ping". If multiple versions of the interface exist, they should
be distinguished by including the version number in the interface name,
as in "Ping3". Casycom uses reply interfaces, rather than reply messages.
These should be the same as the calling interface suffixed with an R,
as in "PingR". Method names should use the same versioning convention,
if needed.
</p><p>
The <tt>signature</tt> contains a textual description of the marshalled
arguments in the message in the form of a sequence of letters.
The meaning of the letters has been copied from the specification for
DBus, which uses a similar system for encoding arguments. Unless otherwise
specified, all arguments are encoded directly, as in <tt>*(uint32_t*)p =
arg;</tt> integer byte order is always little-endian.  Values must be
aligned to the same alignment requrement as in memory, typically the
size of the type.
</p>
<table>
<tr><td>y</td><td>uint8_t</td></tr>
<tr><td>c</td><td>int8_t</td></tr>
<tr><td>q</td><td>uint16_t</td></tr>
<tr><td>n</td><td>int16_t</td></tr>
<tr><td>u</td><td>uint32_t</td></tr>
<tr><td>i</td><td>int32_t</td></tr>
<tr><td>x</td><td>uint64_t</td></tr>
<tr><td>t</td><td>int64_t</td></tr>
<tr><td>f</td><td>float</td></tr>
<tr><td>d</td><td>double</td></tr>
<tr><td>b</td><td>bool. Encoded as uint8_t.</td></tr>
<tr><td>h</td><td>File descriptor. Only valid for messages sent over a UNIX socket.</td></tr>
<tr><td>a</td>
<td>Array. The next letter denotes array type. Encoded with uint32_t
    number of elements followed by the serialized array elements, padded
    to 4-byte alignment. If the elements require alignment greater than
    4, the first element is aligned to the appropriate grain.</td></tr>
<tr><td>s</td>
<td>String. Encoding same as array, with size equal to the length of
    the string including the zero terminator. The length can be set
    to zero for empty strings.</td></tr>
<tr><td>()</td><td>Delimit compound types. Useful after <tt>a</tt></td></tr>
</table>

<h2>COM</h2>
<p>
Each casycom implementation must implement handlers for the COM interface,
used for protocol commands. There are three methods currently defined:
</p><dl>
<dt><tt>Export (const char* el)</tt>, signature "<tt>s</tt>".</dt>
<dd>Contains a comma-delimited list of names of interfaces creatable
    by the sending side. Reply interfaces are never instantiated
    explicitly and are not included in the list.
</dd>
<dt><tt>Error (const char* msg)</tt>, signature "<tt>s</tt>".</dt>
<dd>Sent by the remote object when it encounters an error.</dd>
<dt><tt>Delete (void)</tt>, signature "<tt></tt>".</dt>
<dd>A notification sent by the remote object when it deletes itself.</dd>
</dl>
<p>
Immediately upon establishing a connection, each side must send an
<tt>Export</tt> message, listing exported interfaces. Once the message
is received, the handshake is complete and the connection can be used.
Normal operation involves sending and receiving messages, creating
objects as needed. This completes the protocol specification.
</p>
</div></div>
</body>
</html>
